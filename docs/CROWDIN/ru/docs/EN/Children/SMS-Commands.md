# SMS команды

## Безопасность прежде всего

- AndroidAPS позволяет вам контролировать телефон ребенка удаленно посредством текстовых сообщений (смс). Если смс-коммуникатор активирован, не забывайте, что телефон, настроенный на подачу удаленных команд, может быть украден. Поэтому всегда защищайте смартфон хотя бы ПИН-кодом. Рекомендуется использовать надежный пароль или биометрические данные.
- Кроме этого, рекомендуется иметь [второй телефонный номер](SMS-Commands-authorized-phone-numbers) для SMS-команд. В том случае, если основной удаленный телефон будет потерян или украден, можно командой со второго телефона [временно отключить](SMS-Commands-other) SMS-коммуникатор.
- AndroidAPS также сообщит вам текстовым сообщением, выполнены ли ваши удаленные команды, такие как болюс или изменения профиля. Рекомендуется сделать такую настройку, чтобы подтверждающие тексты направлялись по меньшей мере на два разных телефона на тот случай, если один из них украден.
- **Если вы подаете болюс через SMS-команды необходимо вводить углеводы через Nightscout (AAPSClient, сайт...)**Если вы этого не сделаете, AAPS будет считать, что активных углеводов COB слишком мало и, вероятно, не будет подавать корректировочный болюс, полагая, что у вас много активного инсулина.
- Начиная с версии AndroidAPS 2.7 при использовании SMS-команд необходимо использовать приложение-аутентификатор с одноразовым паролем.

## Настройка SMS-команд

![SMS Commands Setup](../images/SMSCommandsSetup.png)

- Большинство корректировок временных целей, вслед за ААПС и т. д. может быть сделано при помощи приложения [AAPSClient](../Children/Children.md) на телефоне Android с интернет-соединением.
- Болюсы не могут подаваться через Nightscout, но можно использовать SMS-команды.
- Если у вас для слежения iPhone и, следовательно, нет возможности использовать AAPSclient, доступны дополнительные SMS-команды.
- В настройках телефона перейдите в приложения > AndroidAPS > Разрешения и включите SMS

(SMS-Commands-authorized-phone-numbers)=

### Авторизованные номера телефонов

- В AAPS перейдите в **Настройки > SMS Коммуникатор**и введите номер(а) телефона(ов), с которых хотите отправлять SMS команды (разделенные точками с запятыми - напр +6412345678;+6412345679)

- Обратите внимание, что «+» перед номером может быть обязательным или не потребуется в зависимости от вашего местоположения. Для определения этого отправьте образец текста, который будет отображать полученный формат на вкладке SMS Communicator.

- * Включите «Разрешить удаленные команды при помощи SMS».

- Если вы хотите использовать более одного номера:

  - Введите только один номер.

  - Убедитесь, что этот телефон работает с алгоритмом путем отправки и подтверждения команды SMS.

  - Введите дополнительные номера, разделенные точкой с запятой, без пробела.

    ![SMS Commands Setup multiple numbers](../images/SMSCommandsSetupSpace2.png)

### Минуты между командами на болюс

- Можно определить минимальную задержку между двумя болюсами, поданными при помощи SMS.
- Из соображений безопасности следует добавить хотя бы два авторизованных номера телефона для изменения этого значения.

### Дополнительно обязательный пин-код в конце маркера

- По соображениям безопасности за кодом ответа должен следовать PIN.

- Правила установки PIN:

  - от 3 до 6 цифр
  - все цифры различные (например, не 1111)
  - не подряд (например, не 1234)

### Настройка аутентификации

- Для повышения безопасности используется двухфакторная аутентификация.

- Можно использовать любое приложение Authenticator, которое поддерживает маркеры TOTP RFC 6238. Популярные бесплатные приложения:

  - [Приложение Authy](https://authy.com/download/)
  - Google Authenticator - [Android ](https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2)/[iOS](https://apps.apple.com/de/app/google-authenticator/id388497605)
  - [LastPass Authenticator](https://lastpass.com/auth/)
  - [FreeOTP Authenticator](https://freeotp.github.io/)

- Установите на телефоне-фолловере выбранное вами приложение идентификации и просканируйте QR-код, показанный в AAPS.

- Протестируйте одноразовый пароль, введя маркер, показанный в приложении идентификации, и ПИН, который вы только что настроили в AAPS. Пример:

  - Ваш обязательный PIN-код 2020
  - Маркер TOTP из приложения идентификации-457051
  - Введите 4570512020

- Красный текст "НЕПРАВИЛЬНЫЙ ПИН" изменится **автоматически** на зеленый "OK", если запись правильная. **Кнопки для нажатия нет!**

- Время на обоих телефонах должно быть синхронизировано. Оптимальный вариант - установить на автоматическую настройку из сети. Различия во времени могут привести к проблемам аутентификации.

- Используйте кнопку "RESET AUTHENTICATORS"" (СБРОСИТЬ ИДЕНТИФИКАТОРЫ), если хотите их удалить.  (При сбросе аутентификации вы делаете ВСЕ уже предоставленные аутентификаторы недействительными. Вам придется их снова настроить)

## Отправка SMS-Команд

- Отправьте SMS на телефон с AAPS с подтвержденных номеров телефона(ов) используя любую из [команд](SMS-Commands-commands) ниже.

- Телефон с AAPS ответит чтобы подтвердить успешное выполнение команды или запрашиваемого статуса.

- Подтвердите команду, при необходимости отправив код. Пример:

  - Ваш обязательный PIN-код 2020
  - Маркер TOTP из приложения идентификации-457051
  - Введите 4570512020

***Подсказка**: Если отправляется много SMS, полезно иметь тарифный план с неограниченным количеством SMS (на обоих телефонах).

(SMS-команды-команды)=
## Команды

Команды должны отправляться на английском языке, ответ будет получен на русском языке, если строка ответа уже [переведена](translations-translate-strings-for-AAPS-app) <../translations. html#translate-strings-pl-androidaps-app> ` _.

![SMS Commands Example](../images/SMSCommands.png)

### Замкнутый цикл

- LOOP STOP/DISABLE \* Ответ: Цикл отключен

- LOOP START/ENABLE \* Ответ: Цикл включен

- LOOP STATUS

  - Ответ зависит от фактического состояния

    - зцикл не работает
    - зцикл работает
    - Остановлен (на 10 мин)

- LOOP SUSPEND 20 \* Ответ: Цикл приостановлен на 20 минут

- LOOP RESUME \* Ответ: Цикл возобновлен

- ЦИКЛ ЗАМКНУТ \* Ответ: Текущий режим: Закрытый цикл

- ПРИОСТАНОВКА НА НИЗКИХ \* Ответ: Текущий режим: Закрытый цикл

### Данные мониторинга

- BG \* Ответ: Новая ГК: 5.6 4мин назад, Дельта: -0,2 ммоль, Активный инсулин IOB: 0.20 ед. (Болюс: 0.10 ед. Базал: 0.10 ед.)
- CAL 5.6 \* Ответ: Чтобы отправить калибровку 5.6 ответьте с кодом из приложения Authenticator для пользователя, затем PIN \* Ответ после получения верного кода: Калибровка отправлена (**Если установлен xDrip. Разрешение на прием калибровок должно быть включено в xDrip+**)

### Базал

- BASAL STOP/CANCEL \* Ответ: Для остановки временного базала ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом
- BASAL 0.3 \* Ответ: Для постановки базала на 0.3 ед/ч ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом
- BASAL 0.3 20 \* Ответ: Для постановки базала 0.3 ед/ч на 20 мин ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом
- BASAL 30% \* Ответ: Для постановки базала 30% ед/ч на 30 мин. ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом
- BASAL 30% 50 \* Ответ: Для постановки базала 30% ед/ч на 50 мин. ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом

### Болюс

Удаленный болюс разрешается только через 15 минут после предыдущей команды болюс или других удаленных команд (значение редактируется если для передачи команд добавлено 2 номера телефона)! * Поэтому ответ зависит от времени последнего болюса.

- BOLUS 1.2 \* Ответ A: Для подачи болюса 1.2ед ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом \* Ответ B: Удаленный болюс недоступен. Повторите позже.
- BOLUS 0.60 MEAL \*Если указать необязательный параметр MEAL, запускается временная цель MEAL (значения по умолчанию: 90 мг/дл, 5.0 ммоль/л на 45 мин). \* Ответ A: Для подачи болюса 0.60 ед. ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом \* Ответ B: Удаленный болюс недоступен.
- CARBS 5 \* Ответ: Чтобы ввести 5г в 12:45 ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом
- CARBS 5 17:35/5:35PM \* Ответ: Чтобы ввести 5г в 17:35 ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом
- EXTENDED STOP/CANCEL \* Ответ: Для остановки пролонгированного болюса ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом
- EXTENDED 2 120 * Ответ: Чтоб начать пролонгированный болюс 2ед на 120 минут ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом

### Профиль

- PROFILE STATUS \* Ответ: Profile1
- PROFILE LIST \* Ответ: 1.\`Profile1\` 2.\`Profile2\`
- PROFILE 1 \* Ответ: Для переключения профиля на Profile1 100% ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом
- PROFILE 2 30 \* Ответ: Для переключения профиля на Profile2 30% ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом

(SMS-команды-другие)=

### Другое

- TREATMENTS REFRESH \* Ответ: Обновление терапии из NS
- NSCLIENT RESTART \* Ответ: NSCLIENT RESTART команда отправлена
- PUMP \* Ответ: Последнее соед: 1 мин. назад -- Врем базал: 0.00ед/ч @11:38 5/30мин IOB: 0.5ед Резервуар: 34ед Бат: 100
- PUMP CONNECT \* Ответ: Помпа переподключена
- PUMP DISCONNECT *30* \* Ответ: Чтобы разъединить связь с помпой на *30* минут ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом
- SMS DISABLE/STOP \* Ответ: Для отключения удаленного сервиса SMS ответьте любым кодом. Имейте в виду, что после этого его можно повторно активировать только непосредственно с основного смартфона AAPS.
- TARGET MEAL/ACTIVITY/HYPO \* Response: To set the Temp Target MEAL/ACTIVITY/HYPO reply with code from Authenticator app for User followed by PIN
- TARGET STOP/CANCEL \* Ответ: Для остановки временной цели ответьте кодом из приложения Authenticator для Пользователя и подтвердите своим PIN-кодом
- HELP \* Ответ: BG, LOOP, TREATMENTS, ..... (ГК, ЦИКЛ, ТЕРАПИЯ...).....
- HELP BOLUS \* Ответ: BOLUS 1.2 BOLUS 1.2 MEAL (БОЛЮС 1.2 БОЛЮС 1.2 НА ЕДУ)

(SMS-Commands-troubleshooting)=
## Устранение неполадок

### Несколько SMS

Если вы многократно получаете одно и то же сообщение (напр. переключатель профиля), то, возможно, возникла закольцованность с другими приложениями. Например, с xDrip+. Если это так, убедитесь, что xDrip+ (или любое другое приложение) не загружает данные терапии в NS.

Если на других телефонах есть еще это приложение, отключите выгрузку данных на всех этих телефонах.

### Команды SMS не работают на телефонах Samsung

Была жалоба на остановку работы SMS команд после обновления на телефоне Galaxy S10. Решается путем отключения опции "отправлять SMS как сообщения чата".

![Disable SMS as chat message](../images/SMSdisableChat.png)
### Приложение Messages для Android

Если у вас возникают проблемы с отправкой или получением SMS-команд в приложении Android Messages, отключите сквозное шифрование как на телефоне опекуне, так и на детском телефоне.
 - откройте конкретный SMS-диалог в приложении Messages
 - Выберите параметры в правом верхнем углу
 - выберите "Подробности"
 - Активируйте опцию "Отправлять только SMS и MMS"
