# Помпы Medtronic

**>>>> Начиная с версии 2.5 AndroidAPS драйвер помп Medtronic является частью ветки master. Несмотря на это, драйвер Medtronic все еще должен рассматриваться как бета-версия программного обеспечения. Установите, только если вы опытный пользователь. В настоящий момент мы по-прежнему боремся с проблемой двойного болюса (получаем 2 болюса в модуле лечения, что нарушает калькуляцию активного инсулина IOB (если вы получаете эту ошибку, включите Double Bolus Logging в конфигурации Medtronic и пришлите ваши журналы отчета)), должна быть устранена в следующей версии. <<<<**

* * *

Работает только с более старыми помпами Medtronic (подробнее см. ниже). Не работает с Medtronic 640G или 670G.

* * *

Если вы начали пользоваться драйвером Medtronic, включите себя в этот [ список ](https://docs.google.com/spreadsheets/d/16XIjviXe8b-12PrB6brGubNFuAEsFZr10pjLt_SpSFQ/edit#gid=0). Это для того, чтобы можно было видеть, какие телефоны хороши (и какие не очень) для этого драйвера. Там есть один столбец под названием "BT restart" (перезапуск блутуз). Он нужен чтобы проверить, поддерживает ли ваш телефон включение/выключение BT, когда не происходит сопряжения с помпой. Если замечена какая-либо другая проблема, напишите о ней в столбце Комментарии.

* * *

## Требования к аппаратному и программному обеспечению

- **Телефон:**Драйвер Medtronic должен работать с любым телефоном, поддерживающим BLE. **ВАЖНО: Драйвер работает правильно на всех телефонах, а включение/отключение Bluetooth - нет(иногда требуется, когда теряется соединение с RileyLink и система не может восстанавиться автоматически). So you need to get device with Android 7.0 - 8.1, in worst case scenario you can install LinegaeOS 15.1 (required 15.1 or lower) on your phone. Мы изучаем проблему с Android 9, но пока мы не нашли решения (кажется, версия работает только на некоторых моделях).**
- ** RiyeLink/Gnarl: ** Для обмена информацией с помпой необходимо устройство, которое преобразует команды BT из телефона в радиочастотные команды, которые понимает помпа. Устройство, которое выполняет эту задачу, называется RileyLink (его можно найти здесь [ getrileylink.org ](https://getrileylink.org/)). Необходима стабильная версия устройства, 0.9 для старых моделей (еще более старые версии могут работать неправильно) или 2.2 для новых моделей (на сайте RL существует опция обновления). Если вы любите приключения, можете попробовать Gnarl ([здесь](https://github.com/ecc1/gnarl)), который представляет собой клон RileyLink. 
- **помпа:** драйвер работает только со следующими моделями и версиями прошивок: 
    - 512/712
    - 515/715
    - 522/722
    - 523/723 (прошивка 2.4 или ниже)
    - 554/754 версия ЕС (прошивка 2.6A или ниже)
    - 554/754 Канадская версия (прошивка 2.7A или ниже)
- Проверьте прошивку в соответствии с инструкциями в [OpenAPS документы](https://openaps.readthedocs.io/en/latest/docs/Gear%20Up/pump.html#how-to-check-pump-firmware-check-for-absence-of-pc-connect) и [LoopDocs](https://loopkit.github.io/loopdocs/build/step3/#medtronic-pump-firmware).

## Настройка помпы

- **Включите удаленный режим на помпе** (Утилиты -> Параметры удаленной работы, выберите Да, на следующем экране выполните Добавить ID и введите липовый идентификатор (111111 или типа того). Нужен, как минимум, один идентификатор в списке идентификаторов устройств для удаленной работы. Эти опции могут выглядеть по-разному в разных моделях помп. Этот шаг важен, так как при таких настройках помпа будет чаще принимать запрос на дистанционное подключение.
- ** Установите максимальный базал ** как "максимум базала в стандартном профиле" * 4 (если вы хотите получить максимальную временную скорость базала TBR 400%). Как можно видеть в помпе, эта величина не должна превышать 35.
- **Установите макс. болюс** на помпе (максимальная величина 25)
- **Определите профиль как STD **. Это будет единственный профиль, которым мы будем пользоваться. Его также можно отключить.
- ** Задать тип временного базала TBR **как абсолютный (не в процентах)

## Настройка телефона/AndroidAPS

- **Не сопрягайте RileyLink с телефоном.** Если они сопряжены, AndroidAPS не сможете найти его в конфигурации.
- Отключите автоматическое вращение на телефоне (на некоторых устройствах в этом режиме автоматически перезапускаются сеансы bluetooth, что нам не нужно).
- Вы можете настроить помпу в AndroidAPS двумя способами: 

1. Воспользоваться Мастером (при новой установке)
2. Непосредственно на вкладке Конфигурация (Значок шестеренки в графе драйвера Medtronic)

Если вы делаете новую установку, то сразу попадаете в Мастер настройки. Иногда, если соединение BT не работает должным образом (не удается подключиться к помпе), возможно, вы не сможете выполнить настройку. В таком случае выберите виртуальную помпу и после того, как Мастер закончит работу, можно обратиться к варианту 2, который обойдет обнаружение помпы.

![Настройки MDT](../images/Medtronic01a.png)

Необходимо задать следующие параметры: (см. рисунок выше)

- ** Серийный номер помпы **: Он находится на обратной стороне помпы сразу за буквами SN. Нужно вводить только номер, серийный номер состоит из 6 цифр.
- ** Тип помпы **: Какой у вас тип помпы (напр. 522). 
- **Частота помпы**: Существуют две версии помп Medtronic (если вы не уверены, на какой частоте работает ваша помпа, смотрите [справку](../Configuration/MedtronicPump#faq)): 
    - для США & Канады применяется частота 916 МГц
    - для остального мира используется частота 868 МГц
- **Макс болюс на помпе (ед)** (в час): Должен быть таким же какой установлен на помпе. Он ограничивает сколько инсулина можно подать при болюсе. Если его превысить, болюс не будет подан, и появится сообщение об ошибке. Максимальное значение, которое можно задать - 25, задайте его правильно, чтобы не допустить передозировки.
- **Макс база на помпе (ед/ч)**: должна быть такой же, какая установлена на помпе. Это ограничение определяет какая максимальная база подается в час. Например, если вы хотите, чтобы максимальный размер временного базала TBR был равен 500%, а самая высокая скорость базала у вас 1,5 ед, то нужно установить Max Basal не ниже 7.5. Если этот параметр является неправильным (например, если одна из ваших базальных скоростей выше этой величины, помпа выдаст ошибку).
- ** Задержка перед началом подачи болюса **: Это задержка перед отправкой команды помпе на болюс; если вы передумали, есть возможность отменить подачу. Отмена болюса не поддерживается помпой (если вы хотите остановить болюс при подаче, то должны приостановить работу помпы и затем возобновить).
- ** Кодировка Medtronic **: Это значение определяет, будет кодировка 4b6b, которую применяют устройства Medtronic, использоваться в AndroidAPS или в RileyLink. Если у вас RileyLink с прошивкой 2.х, по умолчанию будет применяться аппаратное кодирование (= выполняемое RileyLink), если прошивка 0.х, этот параметр будет игнорироваться.
- **Тип батареи (остаток заряда)**: Если вы хотите видеть уровень заряда помпы, необходимо выбрать тип батареи, (в настоящее время поддерживаются литиевые или щелочные), что, в свою очередь, покажет на дисплее оставшиеся проценты и напряжение заряда.
- ** Конфигурация RileyLink **: Находит устройство RileyLink/GNARL.
- **Set neutral temp basals** is an option which can help prevent Medtronic pumps from beeping on the hour. If enabled if will cancel a temp basal before the hour end to prevent this from happening.

## Вкладка MEDTRONIC (MDT)

![Вкладка MDT](../images/Medtronic02.png)

На вкладке помпы можно видеть несколько строк, которые отображают текущее состояние помпы (и связь).

- **Статус RileyLink**: показывает состояние связи RileyLink. Телефон должен быть все время подключен к RileyLink.
- ** Состояние помпы **: Состояние соединения с помпой, у него может быть несколько значений, но в основном мы увидим значок спящего режима (когда соединение с помпой не активно), при выполнении команды можно видеть "Устанавливается соединение", то есть AAPS пытается соединиться с помпой или описание других команд, выполняемых помпой (например, чтение времени, устанавливается временный базал TBR и т. д.).
- ** Батарея **: Показывает состояние батареи в зависимости от конфигурации. Это может быть простой значок, показывающий, разряжена или заряжена батарея (красным, если заряд критически мал, до 20%), или процент заряда и напряжение.
- ** Последнее соединение **: Время последнего успешного подключения к помпе.
- **Последний болюс**: когда был дан последний болюс.
- ** Базовая скорость базала**: Основная скорость, с которой подается база на помпе в этот час.
- ** Temp basal **: временный базал, который сейчас подается или незаполненная графа.
- ** Резервуар **: Сколько инсулина находится в картридже (обновляется по крайней мере каждый час).
- **ошибки**: строка ошибки, если есть проблемы (в основном показывает, есть ли ошибка в конфигурации).

В нижней части мы имеем три кнопки:

- **Обновить** для обновления состояния. Этот параметр следует использовать только после того, как соединение не будет установлено в течение длительного времени, так как это действие приведет к сбросу данных о помпе (потребуется получить историю данных, получить/установить время, получить профиль, получить состояние батареи и т. д.).
- **Журнал помпы**: показывает хронологию помпы (см. [внизу](../Configuration/MedtronicPump#pump-history))
- **Статистика RL**: показывает статистику RileyLink (см. [внизу](../Configuration/MedtronicPump#rl-status-rileylink-status))

## Журнал помпы

![Диалоговое окно журнала помпы](../images/Medtronic03.png)

Хронология помпы извлекается каждые 5 минут и сохраняется в памяти. Она хранится только последние 24 часа, более старые записи удаляются по мере добавления новых. Это простой способ увидеть события хронологии помпы (некоторые записи могут не отображаться, поскольку не важны - например, конфигурация функций, не используемых AndroidAPS).

## Состояние RL (Состояние RileyLink)

![Состояние RileyLink-Параметры](../images/Medtronic04.png) ![Состояние RileyLink-хронология](../images/Medtronic05.png)

Диалоговое окно имеет две вкладки:

- ** Параметры **: Показывает параметры RileyLink: Сконфигурированный адрес, Подключенное устройство, Состояние соединения, Ошибка соединения и Версия встроенного ПО (прошивки) RileyLink. Типом устройства всегда является Medtronic Pump, Модель - ваша версия модели, Серийный номер-сконфигурированный серийный номер, Частота помпы- Частота на которой работает связь помпы, Последняя частота-последняя используемая частота связи.
- ** История **: Показывает хронологию связи, элементы с RyleyLink показывают изменения состояния RileyLink, Medtronic показывает, какие команды были отправлены на помпу.

## Действия

Если выбран драйвер Medtronic, на вкладке Действия можно добавить три варианта:

- ** Пробуждение и настройка **-Если вы видите, что AndroidAPS не связывался с помпой в течение какого-то времени (он должен связаться каждые 5 минут), вы можете нажать кнопку Настройка. Начнется сеанс связи с помпой с поиском всех подчастот, на которых может выполняться связь. Если обнаружится одна из них, она будет задана как частота по умолчанию. 
- ** Сброс конфигурации RileyLink **-При перезагрузке RileyLink/GNARL необходимо выполнить эту команду, чтобы переконфигурировать устройство (набор частоты, тип частоты, настроенная кодировка).
- ** Очистить Блокировку болюса **-При подаче болюса происходит блокировка, которая предотвращает выполнение любых других команд на помпе. Если остановить помпу и вновь запустить ее (для отмены болюса), то можно удалить эту блокировку. Опция доступна только при подаче болюса... 

## Важные Примечания

### Пользователям OpenAPS

При запуске AndroidAPS главным контроллером является AndroidAPS, и все команды должны идти через него. Подача болюса должна идти через AAPS а не с помпы. У нас есть код, который обнаружит любую команду, выполненную на помпе, но если этого можно избежать, лучше этого не делать (я думаю, что мы устранили все проблемы с историей помпы и синхронизацией истории AAPS, но небольшие проблемы все еще могут появляться, особенно если вы используете нестандартную конфигурацию). С тех пор как я запустил AndroidAPS, я к помпе не прикасался, за исключением тех случаев, когда приходилось менять резервуар, и так и следует пользоваться AndroidAPS.

### Запись логов в файл

Поскольку драйвер Medtronic создан не так давно, следует включить ведение журнала, чтобы мы могли при необходимости отладить и устранить проблемы. Нажмите на значок в верхнем левом углу, выберите обслуживание и настройки журнала. Параметры Помпа, PumpComm, PumpBTComm должны быть отмечены.

### RileyLink/GNARL

При перезапуске RiyeLink или GNARL необходимо либо выполнить новую настройку (действие "Wake and Tune Up"), либо повторно отправить параметры связи (действие "Reset RielyLink Config") иначе обмен информацией завершится неудачей.

### CGM/Непрерывный мониторинг ГК

Мониторинг Medtronic в настоящее время не поддерживается.

### Использование помпы вручную

Не следует выполнять процедуры лечения вручную с помпы. Все команды (болюс, врем базал TBR) должны проходить через AndroidAPS, но если возникнет необходимость выполнять команды вручную, НЕ подавайте их с частотой менее 3 минут (если по какой-то причине подаете 2 болюса, то второй следует начать по крайней мере через 3 минуты после первого).

## Изменения часового пояса и сезонное время или путешествия с помпой Medtronic и AndroidAPS

Важно помнить, что не следует отключать алгоритм цикла во время путешествий и перелетов (если ваш мониторинг может работать в автономном режиме). AAPS автоматически обнаружит изменения часового пояса и отправит команду на помпу когда изменится время на телефоне.

Например, если вы путешествете на Восток и часовой пояс меняется в сторону увеличения (например, с GMT + 0 до GMT + 2), хронология помпы изменится без проблем и вам не о чем беспокоиться... но если вы перемещаетесь на Запад и часовой пояс меняется в сторону уменьшения (например, с GMT + 2 до GMT-0), то возможна небольшая рассинхронизация. Говоря проще, в течение следующих x часов вам придется быть осторожными, потому что активный инсулин IOB, возможно, будет вести себя немного странно.

Мы знаем об этой проблеме, и мы уже ищем возможные решения (см. https://github.com/andyrozman/RileyLinkAAPS/issues/145),, но на данный момент нужно иметь в виду эту информацию при путешествиях.

## Часто задаваемые вопросы

### Можно ли видеть заряд RileyLink/GNARL?

Нет. В данный момент ни одно из этих устройств не поддерживает такую возможность, и ее, скорее всего, не будет и в дальнейшем.

### Является ли GNARL полной заменой RileyLink?

Да. Автор GNARL добавил все функции, используемые драйвером Medtronic. Все средства связи Medtronic поддерживаются (на момент написания (июнь/2019). GNARL нельзя использовать для связи с Omnipod. Недостаток GNARL состоит в том, что его придется собирать самостоятельно, и у вас должна быть совместимая версия оборудования.

** Примечание автора: ** Обратите внимание, что программное обеспечение GNARL по-прежнему экспериментально и недостаточно протестировано и не должно считаться таким же безопасным как RileyLink.

### Где взять RileyLink или GNARL?

Как уже было сказано, устройства можно получить по этим ссылкам:

- RileyLink - здесь - [getrileylink.org](https://getrileylink.org/).
- GNARL- здесь можно получить информацию, но устройство должно быть заказано в другом месте ([ github.com/ecc1/gnarl ](https://github.com/ecc1/gnarl)).

### Что делать, если потеряна связь с RileyLink и/или помпой?

1. Выполните действие "Пробуждения и настройка", оно приведет к попытке найти правильную частоту связи с помпой.
2. Отключите Bluetooth, подождите 10 секунд и снова включите его. Это заставит переподключиться к RileyLink.
3. Выполните сброс RileyLink, после этого не забудьте выполнить действие "сброс конфигурации RileyLink".
4. Попробуйте 3 и 2 вместе.
5. Перезагрузите RileyLink и телефон.

### Как определить, на какой частоте работает помпа

![Модель помпы](../images/Medtronic06.png)

Если перевернуть помпу, в первой строке справа, вы увидите специальный трехбуквенный код. Первые две буквы определяют тип частоты и последняя определяет цвет. Возможны следующие значения частоты:

- NA-Северная Америка (при выборе частоты необходимо выбрать "US & Canada (916 МГц)")
- CA-Канада (для выбора частоты необходимо выбрать "US & Canada (916 МГц)")
- WW- остальные страны (при выборе частоты необходимо выбрать "Worldwide (868 Mhz)")