# Создание андроид-приложения (APK)

## Постройте сами вместо того, чтобы загружать

**AndroidAPS недоступен для скачивания из-за законодательства, касающегося медицинских устройств. Построить приложение для собственного использования вполне законно, но вам не разрешается передавать копию другим! См. раздел [ FAQ ](../Getting-Started/FAQ.md).**

## ## Важные Примечания

* Используйте **[ Android Studio версии 3.6.1 ](https://developer.android.com/studio/)** или новее для построения apk.
* [Windows 10 для 32-разрядных систем](../Installing-AndroidAPS/troubleshooting_androidstudio#unable-to-start-daemon-process) не поддерживается в Android Studio 3.6.1.

** Конфигурация по требованию ** не поддерживается текущей версией модуля Android Gradle!

Если сборка выполнена с ошибкой, относящейся к "выборочной конфигурации", можно сделать следующее:

* Откройте окно настроек, нажав Файл > Настройки (на Mac, Android Studio > Настройки).
* В левой панели нажмите Сборка, Выполнение, Развертывание > Компилятор.
* Снимите флажок с ячейки "выборочная конфигурация".
* Нажмите Применить или OK.

* * *

### Эта статья разделена на две части.

* В обзорной части есть объяснение того, какие шаги необходимы для создания файла APK.
* В пошаговой инструкции вы найдете снимки экранов установки. Поскольку версии Android Studio - среды разработки программного обеспечения, в которой мы будем создавать APK - меняются очень быстро, точного соответствия вашей сборке вы не увидите, но общее представление о том, как это делается, получите. Android Studio работает на Windows, Mac OS X и Linux, и между каждой платформой возможны незначительные различия. Если вы обнаружите, что что-то важное выполняется неправильно или отсутствует, пожалуйста, сообщите в группе facebook "AndroidAPS users" или в чате Gitter [Android APS](https://gitter.im/MilosKozak/AndroidAPS) или [AndroidAPSwiki](https://gitter.im/AndroidAPSwiki/Lobby) чтобы мы могли устранить проблему.

## Общие замечания

В целом, шаги, необходимые для создания файла APK таковы:

1. [Установите Git](../Installing-AndroidAPS/git-install.rst)
2. [Установите Android Studio](../Installing-AndroidAPS/Building-APK#install-android-studio)
3. [Задайте путь к git в параметрах Android Studio](../Installing-AndroidAPS/Building-APK#set-git-path-in-preferences)
4. [Скачайте код AndroidAPS](../Installing-AndroidAPS/Building-APK#download-androidaps-code)
5. [Загрузите Android SDK](../Installing-AndroidAPS/Building-APK#download-android-sdk)
6. [Постройте приложение ](../Installing-AndroidAPS/Building-APK#generate-signed-apk) (сгенерируйте подписанный apk)
7. [Перенесите файл apk на телефон](../Installing-AndroidAPS/Building-APK#transfer-apk-to-smartphone)
8. [Идентифицируйте ресивер при использовании xDrip+](../Installing-AndroidAPS/Building-APK#identify-receiver-if-using-xdrip)

## Пошаговое руководство

Подробное описание шагов, необходимых для создания файла APK.

## Установите git (если у вас его нет)

Следуйте инструкциям на странице установки [git](../Installing-AndroidAPS/git-install.rst).

## Установите Android Studio

Cледующие снимки экрана были сделаны c Android Studio версии 3.6.1. Экран может выглядеть несколько иначе в зависимости от используемой версии Android Studio. Но следует постараться найти свое решение установки. [Помощь от сообщества здесь](../Where-To-Go-For-Help/Connect-with-other-users.md).

Одна из наиболее важных заповедей при установке Android Studio: ** Будьте терпеливы! ** Во время установки и настройки Android Studio загружает многие элементы, которые отнимают время.

Установите [ Android Studio ](https://developer.android.com/studio/install.html) и настройте при первом запуске.

Выберите "Не импортировать настройки", так как вы не использовали их раньше.

![Не импортируйте настройки](../images/AndroidStudio361_01.png)

Решите, хотите ли вы совместно использовать данные с Google или нет.

![Обмен данными с Google](../images/AndroidStudio361_02.png)

На следующем экране нажмите кнопку "Далее".

![Экран приветствия](../images/AndroidStudio361_03.png)

Выберите "Стандартная" установка и нажмите "Далее".

![Стандартная установка](../images/AndroidStudio361_04.png)

Для интерфейса выберите тему, которая вам нравится. (В этом руководстве мы использовали "Светлую".) Затем нажмите кнопку "Далее". Это всего лишь цветовая схема. Можете выбрать любую (напр. Darcula для темного режима). Этот выбор не влияет на построение APK.

![цветовая схема UI](../images/AndroidStudio361_05.png)

Нажмите "Далее" в диалоге "Проверить настройки".

![Подтвердить настройки](../images/AndroidStudio361_06.png)

Подождите, пока Android Studio скачивает дополнительные компоненты и будет терпеливы. После того, как все загрузится кнопка "Готово", станет синей. Теперь нажмите на кнопку.

![Загрузка компонентов](../images/AndroidStudio361_07.png)

## Задайте путь к git в параметрах

Убедитесь, что [ git установлен ](../Installing-AndroidAPS/git-install.rst) на вашем компьютере.

На экране приветствия Android Studio нажмите на маленький треугольник (1. на следующем снимке экрана) и выберите "Настройки" (2.).

![Параметры Android Studio с экрана приветствия](../images/AndroidStudio361_08.png)

### Windows

* Нажмите на маленький треугольник рядом с Контролем Версий (1.) чтобы открыть подменю.
* Нажмите Git (2.).
* Убедитесь, что выбран метод обновления "Слияние" (merge) (3.).
* Проверьте, может ли Android Studio найти путь к файлу git.exe автоматически, нажав кнопку "Тест" (4.)

![Параметры Android Studio](../images/AndroidStudio361_09.png)

* Если автоматическая настройка будет успешной, то будет показана версия git.
* Нажмите кнопку "OK" в диалоговом окне (1.) и "OK" в окне параметров (2.).

![Автоматическая установка git успешно выполнена](../images/AndroidStudio361_10.png)

* В случае, если файл git.exe не найден, нажмите кнопку "OK" в диалоговом окне (1), а затем кнопку с тремя точками (2.).
* Используйте функцию [ поиск ](https://www.tenforums.com/tutorials/94452-search-file-explorer-windows-10-a.html) в проводнике Windows для поиска "git.exe", если вы не уверены в том, где его можно найти. Вы ищете файл git.exe, находящийся в папке \bin\.
* Выберите путь к файлу git.exe и убедитесь, что вы выбрали папку ** \bin\ ** (3.) и нажмите кнопку "OK" (4).
* Закройте окно параметров, нажав кнопку "OK" (5.).

![Автоматическая установка git не выполнена](../images/AndroidStudio361_11.png)

* **Перезагрузите компьютер, чтобы обновить системную среду.**

### Mac

* Любая версия git должна работать. Например <https://git-scm.com/download/mac>.
* Используйте homebrew для установки git: ```$ brew install git```.
* Подробности об установке git см. в [официальной документации git ](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git).
* Если вы устанавливаете git через homebrew, то нет необходимости изменять какие-либо настройки. На всякий случай: Их можно найти здесь: Android Studio - Настройки.

## Скачайте код AndroidAPS

* **Если вы еще не перезагрузили компьютер после настройки пути к git в параметрах, сделайте это сейчас. Необходимо обновить системную среду.**
* На экране приветствия Android Studio щелкните на маленьком треугольнике справа от "Изъять проект из системы управления версиями" (1.).
* Выберите "Git" (2).

![Извлечение проекта из системы управления версиями окна приветствия](../images/AndroidStudio361_12.png)

* Если вы уже открыли Android Studio и не видите экран приветствия, то выберите File (1.) > New (2.) > Project from Version Control... (3.) > Git (4.).

![Извлечение проекта из системы управления версиями в Android Studio](../images/AndroidStudio361_13.png)

* Заполните URL-адрес главного репозитория AndroidAPS ("https://github.com/MilosKozak/AndroidAPS") и нажмите "clone" (клонировать).
* Выберите каталог для сохранения клонированного кода.
* Нажмите кнопку "Test" (2.).
* Если тест не может быть завершен успешно, проверьте еще раз адрес, и нажмите "Проверить".
* Если URL-адрес введен правильно появится сообщение "подключение успешно" (3.).
* Нажмите кнопку "Клонировать" (4.).

![Клонирование репозитория](../images/AndroidStudio361_14.png)

* Не нажимайте "Background", пока клонируется репозиторий!

![Клонирования репозитория - без фоновых действий](../images/AndroidStudio361_15.png)

* После того, как репозиторий клонирован успешно, откройте локальную копию, нажав кнопку "Да".

![Открытие репозитория](../images/AndroidStudio361_16.png)

* В правом нижнем углу появится информация о том, что в Android Studio выполняются фоновые задачи.

![Фоновые задания](../images/AndroidStudio361_17.png)

* Предоставьте доступ, если ваш брандмауэр просит разрешения.

![Разрешение брандмауэра (Java)](../images/AndroidStudio361_18.png)

* После завершения фоновых задач вы, вероятно, увидите следующее сообщение об ошибке:

![Лицензия SDK](../images/AndroidStudio361_19.png)

## Загрузите Android SDK

* Нажмите Файл > Настройки.

![Открыть настройки](../images/AndroidStudio361_20.png)

* Нажмите на маленький треугольник рядом с Appearance & Behaviour (1.).
* Щелкните на небольшом треугольнике рядом с System Settings (2.) и выберите Android SDK (3.)
* Установите флажок слева от "Android 9.0 (Pie)" (4.) (API Level 28).

![Параметры SDK](../images/AndroidStudio361_21.png)

* Подтвердите изменения, нажав кнопку OK.

![Подтвердить изменения SDK](../images/AndroidStudio361_22.png)

* Примите лицензионное соглашение (1.) и нажмите "Далее" (2.).

![Принять лицензию SDK](../images/AndroidStudio361_23.png)

* Дождитесь завершения установки.

![Ожидание во время установки SDK](../images/AndroidStudio361_24.png)

* После завершения установки SDK кнопка "Finish" станет синей. Нажмите на кнопку.

![Завершения установки пакета SDK](../images/AndroidStudio361_25.png)

* Android Studio может рекомендовать обновить систему gradle. **Не обновляйте gradle!** Это может привести к трудностям!
* Если вы видите информацию в нижней правой части окна Android Studio, что модуль Android Gradile готов к обновлениям, щелкните по тексту "update" (1.) и в диалоговом окне выберите "Don't remind me again for this project" (2.).

![Не обновляем gradle](../images/AndroidStudio361_26.png)

## Создание подписанного APK

Подписание означает, что вы подписываете созданное вами приложение, но цифровым способом, как цифровым отпечатком пальца в самом приложении. Это необходимо потому, что Android имеет правило, согласно которому принимается только подписанный код для запуска по соображениям безопасности. Для получения дополнительной информации перейдите по [ этой ссылке](https://developer.android.com/studio/publish/app-signing.html#generate-key).

* Нажмите "Build" в строке меню и выберите "Generate Signed Bundle / APK...".

![Построение apk](../images/AndroidStudio361_27.png)

* Выберите "APK" (1.) вместо "Android App Bundle" и нажмите кнопку "Далее" (2.).

![Apk вместо пакета](../images/AndroidStudio361_28.png)

* Убедитесь, что модуль имеет значение "app" (1.).
* Нажмите "Create new" (cоздать новый...) для создания магазина ключей.
    
    В этом случае магазин ключей является всего лишь файлом, в котором хранится информация о цифровой подписи. Он зашифрован и информация защищена паролями.

![Создание хранилища ключей](../images/AndroidStudio361_29.png)

* Нажмите на символ папки (1.), чтобы выбрать путь к хранилищу ключей. 
* Выберите путь к хранилищу ключей (2.). **Не сохраняйте в той же папке, что и проект. Необходимо использовать другой каталог! ** Одна из опций может быть ваша домашняя папка.
* Введите имя файла для хранилища ключей (3).
* Нажмите "OK" (4.).
* Пароли для хранилища ключей и ключа не должны быть очень сложными. Обязательно запомните их или запишите в безопасное место. В случае, если вы не запомните пароли смотрите [ устранение неполадок для потерянных ключей ](../Installing-AndroidAPS/troubleshooting_androidstudio#lost-keystore).
* Введите (5.) и подтвердите (6.) пароль для хранилища ключей.
* Сделайте то же самое для ключа (7. + 8.).
* Срок действия (9.) по умолчанию составляет 25 лет. Изменять значение по умолчанию не требуется.
* Необходимо ввести имя и фамилию (10). Вся остальная информация необязательна.
* Когда закончите, нажмите кнопку "OK" (11.).

![Путь к магазину ключей](../images/AndroidStudio361_30.png)

* Убедитесь, что поле для запоминания паролей отмечено (1.). Так что вам не нужно вводить их снова при следующей сборке apk (то есть при обновлении до новой версии AndroidAPS).
* Нажмите "Далее" (2.).

![Запомнить пароль](../images/AndroidStudio361_31.png)

* Выберите вариант компоновки "fullRelease" (1.). 
* Отметьте флажки V1 и V2 для подписи версий (2.).
* Нажмите ``Finish``. (3.)

![Завершение сборки](../images/AndroidStudio361_32.png)

* После завершения сборки Android Studio покажет информацию "APK (s) сгенерировано успешно ...".
* В случае, если сборка не удалась, обратитесь к разделу [поиск и устранение неисправностей ](../Installing-AndroidAPS/troubleshooting_androidstudio.rst).
* Самый простой способ найти apk это нажать на кнопку "журнал событий".

![Построено успешно - журнал событий](../images/AndroidStudio361_33.png)

* В секции журнала событий нажмите «locate».

![Журнал событий - обнаружить apk](../images/AndroidStudio361_34.png)

* app-full-release.apk это файл, который вы ищете.

![Расположение файла apk](../images/AndroidStudio361_35.png)

## Перенос приложения на смартфон

Самый простой способ перенести приложение на ваш телефон - [через кабель USB или Google Drive](https://support.google.com/android/answer/9064445?hl=en). Обратите внимание, что передача по почте может вызвать трудности и не является предпочтительным способом.

На вашем телефоне необходимо разрешить установку из неизвестных источников. Инструкции, как это сделать, можно найти в интернете (например [здесь](https://www.expressvpn.com/de/support/vpn-setup/enable-apk-installs-android/) или [здесь](https://www.androidcentral.com/unknown-sources)).

## Идентифицируйте ресивер при использовании xDrip+

[Смотрите страницу xDrip+](../Configuration/xdrip#identify-receiver)

## Устранение неполадок

См. отдельную страницу [ устранение неполадок Android Studio ](../Installing-AndroidAPS/troubleshooting_androidstudio.rst).